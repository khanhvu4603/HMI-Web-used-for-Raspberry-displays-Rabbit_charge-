<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dual - A: QR, B: Buttons</title>
    <link rel="stylesheet" href="../assets/css/styles.css">
</head>
<body data-page="trang2_dual_QR_Buttons_B.html">
    <div class="khung-a-trong">
        <div class="brain-icon">
            <img src="../assets/images/brain-icon.png" alt="Brain Icon">
        </div>
        <div class="tttt-content" id="qrContainerA">
            <h2 class="tttt-title">THANH TOÁN VNPAY</h2>
            <p class="tttt-subtitle" id="qrAmountA">Số tiền: 0 VNĐ</p>
            <div class="loading-spinner" id="loadingSpinnerA" style="display: none; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto;"></div>
            <img id="qrCodeImageA" class="qr-image" src="" alt="QR Code" style="display: none; width: 200px; height: 200px; object-fit: contain; margin: 20px 0; border: 1px solid #ddd; border-radius: 8px;">
            <p class="qr-instruction" style="font-size: 16px; color: #666; margin: 10px 0;">Quét mã QR để thanh toán</p>
            <button class="btn-reset" id="resetButtonA" style="padding: 12px 24px; font-size: 16px; cursor: pointer; border-radius: 8px; border: none; background-color: #6c757d; color: white; font-weight: bold;">Nhập lại</button>
        </div>
    </div>

    <div class="khung-b-trong">
        <div class="brain-icon">
            <img src="../assets/images/brain-icon.png" alt="Brain Icon">
        </div>
        <div class="button-container" style="display: flex; flex-direction: column; gap: 30px; align-items: center; justify-content: center; height: 80%; padding: 20px;">
            <button class="payment-button direct" id="directPaymentButtonB" style="width: 280px; height: 60px; font-size: 18px; font-weight: bold; color: white; border: none; border-radius: 12px; cursor: pointer; background-color: #28a745;">
                Sạc thanh toán trực tiếp
            </button>
            <button class="payment-button app" id="appPaymentButtonB" style="width: 280px; height: 60px; font-size: 18px; font-weight: bold; color: white; border: none; border-radius: 12px; cursor: pointer; background-color: #007bff;">
                Sạc qua app Rabbit EVC
            </button>
        </div>
    </div>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .payment-button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }
        
        .btn-reset:hover {
            background-color: #5a6268;
        }
    </style>

    <script src="../assets/js/store.js"></script>
    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const qrCodeImageA = document.getElementById('qrCodeImageA');
            const qrAmountA = document.getElementById('qrAmountA');
            const loadingSpinnerA = document.getElementById('loadingSpinnerA');
            const resetButtonA = document.getElementById('resetButtonA');
            const directPaymentButtonB = document.getElementById('directPaymentButtonB');
            const appPaymentButtonB = document.getElementById('appPaymentButtonB');

            let paymentPollingIntervalA;

            // Function to format number with thousand separators
            function formatNumber(num) {
                return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            }

            // Function to create ticket and show QR code for Frame A
            async function createTicketAndShowQRA() {
                const amount = window.Store.getItem('paymentAmount');
                
                if (!amount) {
                    qrAmountA.textContent = 'Vui lòng nhập số tiền thanh toán';
                    return;
                }

                // Show loading
                loadingSpinnerA.style.display = 'block';
                qrCodeImageA.style.display = 'none';

                try {
                    const response = await api.createTicket({
                        amount: parseInt(amount),
                        chargePointId: window.Store.getItem('chargePointId') || 'CP001',
                        connectorId: window.Store.getItem('connectorId') || '1',
                        paymentMethod: 'vnpay'
                    });

                    if (response && response.ticketId) {
                        // Store ticket information
                        window.Store.setItem('ticketId', response.ticketId);
                        window.Store.setItem('payUrl', response.payUrl);
                        window.Store.setItem('qrImageDataUrl', response.qrImageDataUrl);
                        window.Store.setItem('expiresAt', response.expiresAt);

                        // Update UI
                        qrAmountA.textContent = `Số tiền: ${formatNumber(amount)} VNĐ`;
                        
                        if (response.qrImageDataUrl) {
                            qrCodeImageA.src = response.qrImageDataUrl;
                        } else if (response.payUrl) {
                            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(response.payUrl)}`;
                            qrCodeImageA.src = qrUrl;
                        }

                        // Hide loading and show QR
                        loadingSpinnerA.style.display = 'none';
                        qrCodeImageA.style.display = 'block';

                        // Start payment polling
                        startPaymentPollingA(response.ticketId);
                    } else {
                        throw new Error('Không thể tạo ticket thanh toán');
                    }
                } catch (error) {
                    console.error('Error creating ticket:', error);
                    loadingSpinnerA.style.display = 'none';
                    alert('Có lỗi xảy ra khi tạo mã QR. Vui lòng thử lại.');
                }
            }

            // Function to poll payment status for Frame A
            async function startPaymentPollingA(ticketId) {
                if (paymentPollingIntervalA) {
                    clearInterval(paymentPollingIntervalA);
                }

                paymentPollingIntervalA = setInterval(async () => {
                    try {
                        const response = await api.getTicketStatus(ticketId);
                        if (response.status === 'PAID') {
                            clearInterval(paymentPollingIntervalA);
                            showPaymentSuccessA();
                        } else if (response.status === 'EXPIRED' || response.status === 'FAILED') {
                            clearInterval(paymentPollingIntervalA);
                            qrAmountA.textContent = `Thanh toán thất bại: ${response.status}`;
                        }
                    } catch (error) {
                        console.error('Error polling payment status for Frame A:', error);
                        clearInterval(paymentPollingIntervalA);
                    }
                }, 5000);
            }

            // Function to show payment success for Frame A
            function showPaymentSuccessA() {
                qrAmountA.textContent = 'Thanh toán thành công!';
                qrAmountA.style.color = '#28a745';
            }

            // Reset function for Frame A
            resetButtonA.addEventListener('click', () => {
                clearInterval(paymentPollingIntervalA);
                window.Store.removeItem('ticketId');
                window.Store.removeItem('paymentAmount');
                window.Store.removeItem('payUrl');
                window.Store.removeItem('qrImageDataUrl');
                window.Store.removeItem('expiresAt');
                window.location.href = 'trang2_1_TTTT.html';
            });

            // Initialize QR display for Frame A if payment amount exists
            const paymentAmount = window.Store.getItem('paymentAmount');
            if (paymentAmount) {
                createTicketAndShowQRA();
            } else {
                qrAmountA.textContent = 'Vui lòng nhập số tiền thanh toán';
            }

            // Event listeners for buttons in Khung B
            directPaymentButtonB.addEventListener('click', () => {
                window.location.href = 'trang2_dual_TTTT.html';
            });

            appPaymentButtonB.addEventListener('click', () => {
                window.location.href = 'trang2_dual_app.html';
            });
        });
    </script>
</body>
</html>
